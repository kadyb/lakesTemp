var table = [ ]; // input pointsFeatures.txt here
var table = ee.FeatureCollection(table);

// Function to mask clouds based on the pixel_qa band of Landsat 457 SR data
function maskL457sr(image) {
  // Bits 3 and 5 are cloud shadow and cloud, respectively
  var cloudShadowBitMask = (1 << 3);
  var cloudsBitMask = (1 << 5);
  // Get the pixel QA band
  var qa = image.select('pixel_qa');
  // Both flags should be set to zero, indicating clear conditions
  var mask = qa.bitwiseAnd(cloudShadowBitMask).eq(0)
                 .and(qa.bitwiseAnd(cloudsBitMask).eq(0));
  return image.updateMask(mask);
}

// Load the image data
// (remember to change Landsat source)
var data = ee.ImageCollection('LANDSAT/LE07/C01/T1_SR')
              .filter(ee.Filter.calendarRange(4, 10, 'month'))
              .filterBounds(table)
              .filterMetadata('CLOUD_COVER', 'less_than', 70)
              .map(maskL457sr)
              .select(['B1', 'B2', 'B3', 'B4', 'B5', 'B6', 
                      'B7', 'sr_atmos_opacity']);

// Map over the images and use reduceRegions() to extract data
var featureCollection = data.map(function(image){
  var dataOutput = image.reduceRegions(table, ee.Reducer.mean(), 30);
  return dataOutput;
}).flatten();
var featureCollection = featureCollection.filterMetadata('B1', 'not_equals', null);

// Export data as CSV
// (remember to change file name accordingly)
Export.table.toDrive({
  collection: featureCollection,
  description: 'Landsat7_GEE',
  selectors: ['system:index', 'oid', 'B1', 'B2', 'B3', 'B4',
              'B5', 'B6','B7', 'sr_atmos_opacity']
});
